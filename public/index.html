<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>$tABS â€” Token Platform</title>
<style>
  :root{ --abs-green:#07c160; --bg:#0b1f17; --panel:#0f2a20; --muted:#89b6a0; --text:#e8fff3; --danger:#ff6b6b; --info:#5aa7ff; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; min-height:100vh; display:flex; flex-direction:column;
    background: radial-gradient(1200px 600px at 70% -10%, rgba(7,193,96,.15), transparent), var(--bg);
    color:var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size:16px;
  }
  main{flex:1 0 auto} footer{flex-shrink:0}

  .mono, table, .hstat b, .tag, .pill, .muted, h2, .tabbtn { font-family:"Liberation Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace !important; }
  a{color:inherit;text-decoration:none}

  .wrap{max-width:1200px;margin:0 auto;padding:18px 24px}
  header{position:sticky;top:0;backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(11,31,23,.9),rgba(11,31,23,.5));border-bottom:1px solid rgba(255,255,255,.06);z-index:20}
  .brand{display:flex;align-items:center;gap:12px}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);padding:8px 12px;border-radius:999px;color:var(--muted)}
  .headerbar{display:flex;align-items:center;justify-content:space-between;gap:18px;flex-wrap:wrap}
  .header-right{display:flex;align-items:center;gap:14px;flex-wrap:wrap}

  .hstats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;min-width:520px}
  .hstat{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 10px;min-width:120px}
  .hstat small{display:block;color:var(--muted);font-size:.75rem}
  .hstat b{font-size:1rem}
  .delta-pos{color:#38e08a;font-weight:800}
  .delta-neg{color:#ff8585;font-weight:800}
  .tabs-icon{width:48px;height:48px;border-radius:10px;overflow:hidden;box-shadow:0 0 14px rgba(7,193,96,.35)}
  @media (max-width: 980px) { .hstats{grid-template-columns:repeat(2,1fr); min-width:unset; width:100%} }

  .panel{background:linear-gradient(135deg, rgba(7,193,96,.12), rgba(7,193,96,.03)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px}

  .controls{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:10px;flex-wrap:wrap}
  .controls-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .center-status{flex:1;text-align:center;min-height:22px}
  .tabbtn{background:transparent;border:1px solid rgba(255,255,255,.18);color:#d9ffe8;border-radius:10px;padding:8px 12px;cursor:pointer}
  .tabbtn.active{background:var(--abs-green);color:#062412;border-color:transparent;box-shadow:0 6px 20px rgba(7,193,96,.35)}

  .btn{background:var(--abs-green);border:none;color:#062412;font-weight:800;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:0 6px 20px rgba(7,193,96,.35)}
  .btn.smol{padding:8px 12px}
  .btn.danger{ background:var(--danger); color:#2b0f10; box-shadow:0 6px 20px rgba(255,107,107,.45) }
  .btn.info{ background:var(--info); color:#041b33; box-shadow:0 6px 20px rgba(90,167,255,.35) }

  .search{display:flex;gap:10px;min-width:280px}
  .search input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.06);color:var(--text)}

  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{color:var(--muted);font-weight:700;text-align:left;font-size:.9rem;padding:0 12px}
  tbody tr{background:var(--panel);border:1px solid rgba(255,255,255,.06)}
  tbody td{padding:12px 12px; vertical-align:middle}
  tbody tr{border-radius:12px}
  tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  .chg-pos{color:#3ee98f;font-weight:800}
  .chg-neg{color:#ff8585;font-weight:800}
  .tag{padding:2px 8px;border-radius:6px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:#d9ffe8;font-size:.75rem}
  .rowhead{display:flex;align-items:center;gap:10px}
  .tokicon{width:30px;height:30px;border-radius:8px;object-fit:cover;background:#0a1a14;cursor:pointer}

  .expander{margin-top:8px;border:1px dashed rgba(255,255,255,.2);border-radius:10px}
  .expander > button{width:100%;text-align:center;background:transparent;border:none;color:var(--muted);padding:10px;cursor:pointer}
  .expander .tray{display:none;padding:10px;background:transparent}
  .expander.open .tray{display:block}
  .expander.open > button{color:#d9ffe8}

  .below-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .box{background:linear-gradient(135deg, rgba(7,193,96,.08), rgba(7,193,96,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;min-height:220px;overflow-x:auto}
  .box h3{margin:0 0 8px}

  /* Make the bubble canvas taller on desktop */
  #bubble-canvas{min-height:520px; height:600px}
  @media (max-width: 900px) { .below-grid{grid-template-columns:1fr} #bubble-canvas{height:320px} }
  @media (max-width: 480px) { #bubble-canvas{height:240px} }

  .status-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:10px}
  @media (max-width:900px), (orientation:portrait){ .status-grid{grid-template-columns:repeat(3,1fr)} }
  .s-pill{display:flex;align-items:center;justify-content:center;border-radius:10px;padding:6px 6px;font-size:.75rem;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04)}
  .s-tag{padding:2px 8px;border-radius:14px;border:1px solid rgba(255,255,255,.18);font-size:.75rem}
  .s-hold{color:#3ee98f}.s-more{color:#ffd166}.s-part{color:#6cf0ff}.s-sold{color:#ff8585}

  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:60}
  .overlay-card{width:min(860px,92vw);max-height:80vh;overflow:auto;background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px;position:relative}
  .overlay-close{position:absolute;top:10px;right:10px;border:none;background:transparent;color:#fff;font-size:18px;cursor:pointer}

  footer{padding:16px 0 24px;color:var(--muted);text-align:center;background:linear-gradient(to top, rgba(7,193,96,.08), rgba(7,193,96,0))}

  /* A-panel stat rows */
  #aTokenStats{margin-bottom:8px}
  #aTokenStats .statrow{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px dashed rgba(255,255,255,.10)}
  #aTokenStats .statrow b{font-weight:600}
  #aTokenStats .statrow span{text-align:right}

  /* small screens */
  @media (max-width:700px){
    body{font-size:15px}
    .wrap{padding:14px 16px}
    .panel{padding:12px}
    .box{padding:12px}
    .tabbtn{padding:6px 10px;font-size:.9rem}
    .btn{padding:8px 12px}
    .btn.smol{padding:7px 10px}
    .search input{padding:8px 10px}
    thead th{font-size:.8rem}
    tbody td{padding:10px 10px}
    .tokicon{width:26px;height:26px}
    #aTokenStats .statrow{padding:5px 6px}
  }
  @media (max-width:480px){
    body{font-size:14px}
    .headerbar{gap:12px}
    .hstats{gap:8px}
    .hstat{padding:6px 8px}
    .hstat b{font-size:.95rem}
    .pill{padding:6px 10px}
    .tabbtn{padding:6px 8px}
    .btn{padding:7px 10px}
    .search{min-width:0}
    .search input{min-width:0;width:100%}
    table{border-spacing:0 8px}
    tbody td{padding:8px 8px}
  }
</style>
</head>
<body>
  <header>
    <div class="wrap headerbar">
      <div class="brand">
        <img class="tabs-icon" src="https://cdn.dexscreener.com/cms/images/4GoBllwMTEijvbAI?width=64&height=64&fit=crop&quality=95&format=auto" alt="$tABS">
        <div>
          <div style="font-weight:800;letter-spacing:.4px">$tABS Analytics</div>
          <div class="muted mono" id="trackedLine" style="font-size:.85rem">â€” tokens tracked</div>
        </div>
      </div>
      <div class="header-right">
        <div class="hstats">
          <div class="hstat mono"><small>Market Cap</small><b id="tabsCap">$0</b></div>
          <div class="hstat mono"><small>24h Volume</small><b id="tabsVol">$0</b></div>
          <div class="hstat mono"><small>Holders</small><b id="tabsHolders">â€”</b></div>
          <div class="hstat mono"><small>24h Change</small><b id="tabsChg" class="delta-pos">0%</b></div>
        </div>
        <div class="pill mono"><a id="tabsLink" target="_blank" rel="noopener">DexScreener</a></div>
      </div>
    </div>
  </header>

  <main>
    <!-- TOP PANEL -->
    <section class="wrap">
      <div class="panel">
        <div class="controls">
          <div class="controls-left">
            <button id="tabGainers" class="tabbtn active">ðŸš€ Top Gainers (24h)</button>
            <button id="tabVol" class="tabbtn">ðŸ“ˆ Top Vol (24h)</button>
            <button id="clearBtn" class="btn smol mono danger" style="display:none">Clear</button>
            <button id="reloadBtn" class="btn smol mono info" style="display:none">Reload</button>
          </div>

          <div id="scanStatus" class="center-status mono muted"></div>

          <div class="search">
            <input id="search" class="mono" placeholder="Paste a CA for singleâ€‘token view, or type to filterâ€¦" />
            <button class="btn mono" id="refresh">Refresh</button>
          </div>
        </div>

        <table id="gainers" class="mono">
          <thead>
            <tr><th>#</th><th>Token</th><th>24h %</th><th>24h Vol</th><th>Mkt Cap</th></tr>
          </thead>
          <tbody id="top5"></tbody>
        </table>

        <div class="expander" id="expander">
          <button class="mono" id="toggleExpand">Show more (+10)</button>
          <div class="tray"><table class="mono" style="width:100%"><tbody id="rest10"></tbody></table></div>
        </div>
      </div>
    </section>

    <!-- FULLâ€‘WIDTH PANEL A+B -->
    <section class="wrap below">
      <div class="panel">
        <div class="below-grid">
          <!-- A -->
          <div class="box" id="boxLeft">
            <h3 class="mono" id="aTitle">Token Allocation &amp; Stats <small class="muted mono" id="aSnapshot" style="font-weight:400;margin-left:6px"></small></h3>
            <div id="aTokenStats"></div>
            <div id="bubble-canvas"></div>
            <div class="mono muted" id="a-bubble-note"><span id="bubbleStatusText"></span></div>
          </div>

          <!-- B -->
          <div class="box" id="boxRight">
            <h3 class="mono">Wallets â€¢ First 25 vs Top 25</h3>
            <div id="statusGrid" class="status-grid"></div>
            <div class="controls-left" style="margin-bottom:8px">
              <button id="btnFirst25" class="tabbtn active">First 25 unique recipients</button>
              <button id="btnTop25" class="tabbtn">Top 25 holders</button>
            </div>

            <div id="buyersPanelB">
              <table class="mono">
                <thead>
                  <tr><th>#</th><th>Address</th><th>First In</th><th>Total In</th><th>Total Out</th><th>Holdings</th><th>Status</th></tr>
                </thead>
                <tbody id="buyersTop5"></tbody>
              </table>
              <div class="expander" id="buyersExpander" style="margin-top:8px;display:none">
                <button id="buyersToggle" class="mono">Show more (+20)</button>
                <div class="tray"><table class="mono" style="width:100%"><tbody id="buyersRest"></tbody></table></div>
              </div>
              <div id="buyersHelperText" class="mono muted" style="margin-top:6px">Click Address for ABS scan<br>Hit the row for the I sue you Profiler</div>
            </div>

            <div id="holdersPanelB" style="display:none">
              <table class="mono">
                <thead>
                  <tr><th>#</th><th>Address</th><th>First In</th><th>Total Holdings</th><th>% of Supply</th></tr>
                </thead>
                <tbody id="holdersTop5"></tbody>
              </table>
              <div class="expander" id="holdersExpander" style="margin-top:8px;display:none">
                <button id="holdersToggle" class="mono">Show more (+20)</button>
                <div class="tray"><table class="mono" style="width:100%"><tbody id="holdersRest"></tbody></table></div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Overlays -->
  <div class="overlay" id="fundersOverlay">
    <div class="overlay-card">
      <button id="closeFunders" class="overlay-close">âœ•</button>
      <h4 class="mono">I Sue You Profiler â€” who is the sniper?</h4>
      <div id="fundersInner"></div>
    </div>
  </div>
  <div class="overlay" id="commonOverlay">
    <div class="overlay-card">
      <button id="closeCommon" class="overlay-close">âœ•</button>
      <h4 class="mono">Common funders</h4>
      <div id="commonInner"></div>
    </div>
  </div>

  <footer>
    <div class="wrap mono">
      <p style="font-size:0.8rem;color:#777;margin-top:1rem;">
        by the <a href="https://www.twitter.com/totally_abs" target="_blank" style="color:#00ff9c;text-decoration:none;">totally ABS Team</a> 2025,  
        All graphics by <a href="https://twitter.com/wa666mr" target="_blank" style="color:#00ff9c;text-decoration:none;">WaWa</a>.
      </p>
      <p style="font-size:0.8rem;color:#777;margin-top:0.2rem;">
        This site uses <a href="https://d3js.org/" target="_blank" style="color:#00ff9c;text-decoration:none;">D3.js</a>,  
        Â© 2010â€“2025 Mike Bostock. Released under the 
        <a href="https://opensource.org/licenses/BSD-3-Clause" target="_blank" style="color:#00ff9c;text-decoration:none;">BSD 3-Clause License</a>.
      </p>
    </div>
  </footer>

<!-- ===== Page logic ===== -->
<script>
(function(){
  const SPECIAL_CA = '0x8c3d850313eb9621605cd6a1acb2830962426f67'.toLowerCase();

  // utils
  const iconCache = {};
  async function getTokenIcon(addr){
    if(!addr) return null;
    const a=addr.toLowerCase(); if(iconCache[a]) return iconCache[a];
    try{
      const res=await fetch(`https://api.dexscreener.com/tokens/v1/abstract/${a}`);
      const data=await res.json();
      if(Array.isArray(data)&&data[0]?.info?.imageUrl){ iconCache[a]=data[0].info.imageUrl; return iconCache[a]; }
    }catch(e){ console.error("Icon fetch error",a,e); }
    return null;
  }
  const fmtUSD=(n)=> (n==null||isNaN(n)) ? '$0' : '$'+Intl.NumberFormat('en-US',{notation:'compact',maximumFractionDigits:2}).format(n);
  const td=(v,cls='')=>`<td class="${cls}">${v}</td>`;
  const chg=(x)=>`<span class="${(x??0)>=0?'chg-pos':'chg-neg'}">${(x??0).toFixed(2)}%</span>`;
  const isCA=(s)=>/^0x[a-fA-F0-9]{40}$/.test((s||'').trim());

  // header render: prefer bannerSpecial (tABS) if present
  function renderHeaderStats(b, special){
    const fmt=(n)=>'$'+Intl.NumberFormat('en-US',{notation:'compact',maximumFractionDigits:2}).format(n||0);
    if (special){
      document.getElementById('tabsCap').textContent = fmt(special.cap || 0);
      document.getElementById('tabsVol').textContent = fmt(special.vol24 || 0);
      const chgEl = document.getElementById('tabsChg');
      const c = Number(special.chg24 || 0);
      chgEl.textContent = c.toFixed(2) + '%';
      chgEl.className = c >= 0 ? 'delta-pos mono' : 'delta-neg mono';
      document.getElementById('tabsLink').href = special.url || '#';
      return;
    }
    if(!b) return;
    const capVal = (typeof b.fdv === 'number' && !isNaN(b.fdv)) ? b.fdv
                   : (typeof b.marketCap === 'number' ? b.marketCap : 0);
    document.getElementById('tabsCap').textContent = fmt(capVal);
    document.getElementById('tabsVol').textContent = fmt(b.vol24 || 0);
    const chgEl = document.getElementById('tabsChg');
    chgEl.textContent = ((b.chg24 ?? 0).toFixed(2)) + '%';
    chgEl.className = (b.chg24 ?? 0) >= 0 ? 'delta-pos mono' : 'delta-neg mono';
    document.getElementById('tabsLink').href = b.url || '#';
  }
  function setTracked(n){ document.getElementById('trackedLine').textContent = `${(n||0).toLocaleString('en-US')} tokens tracked`; }

  // table rows
  async function mkRow(i,r){
    const icon = await getTokenIcon(r.baseAddress);
    const iconHtml = icon ? `<img class="tokicon tokclick" data-ca="${r.baseAddress}" src="${icon}" alt="" title="Singleâ€‘token view">` : ``;
    const head = `<div class="rowhead"><span>#${r.rank ?? (i+1)}</span>${iconHtml}</div>`;
    const name = r.url ? `<a href="${r.url}" target="_blank" rel="noopener">${r.name || 'â€”'} <span class="tag">${r.symbol || ''}</span></a>`
                     : `${r.name || 'â€”'} <span class="tag">${r.symbol || ''}</span>`;
    const capVal = (r.marketCap != null && isFinite(r.marketCap)) ? r.marketCap
                 : (r.fdv != null && isFinite(r.fdv)) ? r.fdv
                 : null;
    return `<tr>${td(head)}${td(name)}${td(chg(r.priceChange?.h24))}${td(fmtUSD(r.volume24h))}${td(capVal!=null ? fmtUSD(capVal) : 'â€”')}</tr>`;
  }
  function wireTokenIconClicks(){
    document.querySelectorAll('.tokclick').forEach(img=>{
      img.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); startSingleFromIcon(img.dataset.ca); });
    });
  }
  async function renderTableRows(list){
    const q=(document.getElementById('search').value||'').toLowerCase();
    const rows=(list||[]).filter(r=>{
      const n=(r.name||'').toLowerCase(), s=(r.symbol||'').toLowerCase();
      return !q || n.includes(q) || s.includes(q);
    });
    const top5=rows.slice(0,5), rest10=rows.slice(5,15);
    document.getElementById('top5').innerHTML   = (await Promise.all(top5.map((r,i)=>mkRow(i,r)))).join('');
    document.getElementById('rest10').innerHTML = (await Promise.all(rest10.map((r,i)=>mkRow(i+5,r)))).join('');
    document.getElementById('expander').style.display = rows.length>5 ? '' : 'none';
    wireTokenIconClicks();
  }

  // API helpers that always return the snapshot object (not wrapper)
  async function latest(){
    const r=await fetch('/api/snapshot/latest');
    const j=await r.json();
    return j && j.ok ? j.snapshot : null;
  }
  async function refresh(){
    const r=await fetch('/api/refresh',{method:'POST'});
    const j=await r.json();
    return j && j.ok ? j.snapshot : null;
  }
  async function addToken(ca){
    const r=await fetch('/api/add-token',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ca})});
    return r.json();
  }

  // state
  let snap=null, mode='gainers', single=false, currentCA=null;
  const tabGainersBtn = document.getElementById('tabGainers');
  const tabVolBtn     = document.getElementById('tabVol');
  const clearBtn      = document.getElementById('clearBtn');
  const reloadBtn     = document.getElementById('reloadBtn');
  const scanStatus    = document.getElementById('scanStatus');

  function applyMode(){ tabGainersBtn.classList.toggle('active',mode==='gainers'); tabVolBtn.classList.toggle('active',mode==='vol'); }
  async function renderByMode(){ if(!snap) return; const list=mode==='gainers'?(snap.topGainers||[]):(snap.topVol||[]); await renderTableRows(list); }

  function enterSingleTokenMode(){
    single=true; tabGainersBtn.style.display='none'; tabVolBtn.style.display='none';
    clearBtn.style.display='inline-flex'; reloadBtn.style.display='inline-flex';
  }
  function exitSingleTokenMode(){
    single=false; currentCA=null; document.getElementById('search').value='';
    tabGainersBtn.style.display=''; tabVolBtn.style.display='';
    clearBtn.style.display='none'; reloadBtn.style.display='none';
    scanStatus.textContent='';
  }

  async function renderSingle(ca){
    enterSingleTokenMode(); currentCA=ca.toLowerCase();
    document.getElementById('expander').style.display='none';
    try{
      const j=await addToken(currentCA);
      if(!j.ok || !j.row){
        document.getElementById('top5').innerHTML=`<tr><td colspan="5">No data for ${currentCA}</td></tr>`;
        document.getElementById('rest10').innerHTML='';
      }else{
        setTracked(j.tokensTracked);
        document.getElementById('top5').innerHTML = await mkRow(0,j.row);
        document.getElementById('rest10').innerHTML='';
      }
    }catch(e){
      document.getElementById('top5').innerHTML=`<tr><td colspan="5">Fetch error for ${currentCA}</td></tr>`;
      document.getElementById('rest10').innerHTML='';
    }
    if(window.TABS_EXT) window.TABS_EXT.startScan(currentCA); // integration populates A+B
  }
  async function startSingleFromIcon(ca){ document.getElementById('search').value=ca; await renderSingle(ca); }

  // Twoâ€‘phase boot: instant cached â†’ background fresh
  async function boot(){
    try {
      const cached = await latest(); // fast (snapshots.json)
      if (cached) {
        snap = cached;
        renderHeaderStats(snap.banner, snap.bannerSpecial);
        setTracked(snap.tokensTracked || 0);
        applyMode(); await renderByMode();
        scanStatus.textContent = 'Updatingâ€¦ fetching fresh stats in the background.';
      } else {
        scanStatus.textContent = 'No cached snapshot yet. Building oneâ€¦';
      }
    } catch (e) {
      console.warn('Load cached failed:', e);
    }

    try {
      const fresh = await refresh(); // slower (live scan)
      if (fresh && (!snap || fresh.ts !== snap.ts)) {
        snap = fresh;
        renderHeaderStats(snap.banner, snap.bannerSpecial);
        setTracked(snap.tokensTracked || 0);
        applyMode(); await renderByMode();
        scanStatus.textContent = 'Updated just now.';
      } else if (!snap) {
        scanStatus.textContent = 'No snapshot available.';
      } else {
        scanStatus.textContent = 'Already up to date.';
      }
    } catch (e) {
      console.warn('Background refresh failed:', e);
      if (!snap) document.getElementById('top5').innerHTML = `<tr><td colspan="5">Snapshot build failed.</td></tr>`;
      scanStatus.textContent = 'Using cached snapshot (refresh failed).';
    } finally {
      setTimeout(()=> (scanStatus.textContent=''), 2500);
    }
  }

  // top controls
  tabGainersBtn.onclick=async()=>{ if(single) return; mode='gainers'; applyMode(); await renderByMode(); };
  tabVolBtn.onclick    =async()=>{ if(single) return; mode='vol';     applyMode(); await renderByMode(); };
  clearBtn.onclick = async ()=>{ exitSingleTokenMode(); if(window.TABS_EXT) window.TABS_EXT.reset(); mode='gainers'; applyMode(); await renderByMode(); document.getElementById('expander').style.display=''; };
  reloadBtn.onclick=async()=>{ if(!currentCA) return; if(window.TABS_EXT) window.TABS_EXT.startScan(currentCA,{force:true}); };
  document.getElementById('toggleExpand').onclick=()=>{
    const e=document.getElementById('expander'); e.classList.toggle('open');
    document.getElementById('toggleExpand').textContent = e.classList.contains('open') ? 'Show less (âˆ’10)' : 'Show more (+10)';
  };
  document.getElementById('refresh').onclick=async()=>{
    const q=(document.getElementById('search').value||'').trim();
    if(q===''){
      scanStatus.textContent = 'Refreshing snapshotâ€¦';
      try{
        const fresh = await refresh();
        if (fresh && (!snap || fresh.ts !== snap.ts)) {
          snap = fresh;
          renderHeaderStats(snap.banner, snap.bannerSpecial);
          setTracked(snap.tokensTracked || 0);
          applyMode(); await renderByMode();
          scanStatus.textContent = 'Updated.';
        } else {
          scanStatus.textContent = 'Already up to date.';
        }
      }catch(e){
        scanStatus.textContent = 'Refresh failed (using cached snapshot).';
      } finally {
        setTimeout(()=> (scanStatus.textContent=''), 2500);
      }
    } else if (isCA(q)) {
      await renderSingle(q);
    } else {
      if(!single) await renderByMode();
    }
  };
  document.getElementById('search').addEventListener('input', async ()=>{ if(single) return; await renderByMode(); });

  // expose tiny API for icon clicks (used by row icons)
  window.TABS_APP = { boot, startSingleFromIcon };
})();
</script>

<!-- d3 for bubble map -->
<script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
<!-- integration for A + B -->
<script src="/abs-tabs-integration.js"></script>
<script>
  if (window.TABS_EXT) window.TABS_EXT.init();
  if (window.TABS_APP) window.TABS_APP.boot();
</script>
</body>
</html>
